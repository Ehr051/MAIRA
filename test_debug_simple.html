<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Debug MAIRA - Crear Partida</title>
    <style>
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f8f9fa; 
        }
        .container { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 20px;
        }
        .card { 
            background: white; 
            border: 1px solid #dee2e6; 
            border-radius: 8px; 
            padding: 20px; 
        }
        .card h3 { 
            margin-top: 0; 
            color: #495057; 
            border-bottom: 2px solid #007bff; 
            padding-bottom: 8px; 
        }
        .status { 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
            font-weight: bold; 
            text-align: center;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .status.connecting { background: #fff3cd; color: #856404; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px 0; 
            width: 100%; 
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        input, textarea { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            margin: 5px 0; 
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            font-family: monospace;
            font-size: 12px;
        }
        .form-group { 
            margin: 15px 0; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 600; 
        }
        .log-area { 
            background: #2d3748; 
            color: #e2e8f0; 
            border-radius: 4px; 
            padding: 15px; 
            height: 400px; 
            overflow-y: auto; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            white-space: pre-wrap; 
            margin-top: 10px;
        }
        .success { color: #48bb78; }
        .error { color: #f56565; }
        .warning { color: #ed8936; }
        .info { color: #4299e1; }
        .full-width { grid-column: 1 / -1; }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .stat {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            font-size: 12px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <h1>üîß Debug MAIRA - Crear Partida Online</h1>
    <p><strong>Prop√≥sito:</strong> Diagnosticar problemas de creaci√≥n de partidas online con Socket.IO</p>
    
    <div class="container">
        <!-- Panel de Control -->
        <div class="card">
            <h3>üéÆ Control</h3>
            
            <div id="socketStatus" class="status disconnected">
                üî¥ Socket: Desconectado
            </div>
            
            <div class="form-group">
                <label>üë§ Usuario de Prueba:</label>
                <input type="text" id="testUser" value="DebugUser_" placeholder="Nombre usuario">
            </div>
            
            <button onclick="conectar()" id="btnConectar">üîå Conectar Socket</button>
            <button onclick="desconectar()" id="btnDesconectar" disabled>‚ùå Desconectar</button>
            
            <hr>
            
            <h4>üéØ Crear Partida</h4>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="nombrePartida" value="Partida Debug Test">
            </div>
            <div class="form-group">
                <label>Duraci√≥n (min):</label>
                <input type="number" id="duracionPartida" value="30">
            </div>
            <div class="form-group">
                <label>Duraci√≥n Turno (min):</label>
                <input type="number" id="duracionTurno" value="5">
            </div>
            <div class="form-group">
                <label>Objetivo:</label>
                <input type="text" id="objetivoPartida" value="Test de debug">
            </div>
            
            <button onclick="crearPartida()" id="btnCrear" disabled>üéØ Crear Partida</button>
            <button onclick="obtenerPartidas()" id="btnListar" disabled>üìã Listar Partidas</button>
            
            <button onclick="limpiarLog()" style="background: #6c757d; margin-top: 20px;">üßπ Limpiar Log</button>
        </div>
        
        <!-- Panel de Estado -->
        <div class="card">
            <h3>üìä Estado</h3>
            
            <div class="stats">
                <div class="stat">
                    <div class="stat-value" id="enviados">0</div>
                    <div class="stat-label">Enviados</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="recibidos">0</div>
                    <div class="stat-label">Recibidos</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="errores">0</div>
                    <div class="stat-label">Errores</div>
                </div>
            </div>
            
            <div><strong>Socket ID:</strong> <span id="socketId">-</span></div>
            <div><strong>Usuario ID:</strong> <span id="userId">-</span></div>
            <div><strong>Estado:</strong> <span id="estado">Desconectado</span></div>
            <div><strong>√öltima actividad:</strong> <span id="ultimaActividad">-</span></div>
            
            <div style="margin-top: 20px;">
                <h4>üéØ Partida Actual</h4>
                <div id="partidaInfo">Sin partida activa</div>
            </div>
            
            <div style="margin-top: 20px;">
                <h4>üß™ Test Manual</h4>
                <textarea id="jsonData" placeholder='{"evento": "datos"}'></textarea>
                <button onclick="enviarCustom()" id="btnCustom" disabled style="background: #28a745;">üì§ Enviar JSON</button>
            </div>
        </div>
    </div>
    
    <!-- Log Completo -->
    <div class="card full-width">
        <h3>üìù Log de Eventos en Tiempo Real</h3>
        <div id="logArea" class="log-area"></div>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        let socket = null;
        let userId = null;
        let partidaActual = null;
        let contadores = { enviados: 0, recibidos: 0, errores: 0 };
        
        function log(mensaje, tipo = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logArea');
            const clase = tipo === 'error' ? 'error' : tipo === 'success' ? 'success' : tipo === 'warning' ? 'warning' : 'info';
            
            logArea.innerHTML += `<span class="${clase}">[${timestamp}] ${mensaje}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
            
            document.getElementById('ultimaActividad').textContent = timestamp;
        }
        
        function actualizarContadores() {
            document.getElementById('enviados').textContent = contadores.enviados;
            document.getElementById('recibidos').textContent = contadores.recibidos;
            document.getElementById('errores').textContent = contadores.errores;
        }
        
        function actualizarEstado(estado, socketId = null) {
            const statusDiv = document.getElementById('socketStatus');
            document.getElementById('estado').textContent = estado;
            if (socketId) document.getElementById('socketId').textContent = socketId;
            
            const isConnected = estado === 'Conectado';
            statusDiv.className = `status ${isConnected ? 'connected' : estado === 'Conectando' ? 'connecting' : 'disconnected'}`;
            statusDiv.innerHTML = `${isConnected ? 'üü¢' : estado === 'Conectando' ? 'üü°' : 'üî¥'} Socket: ${estado}`;
            
            document.getElementById('btnConectar').disabled = isConnected;
            document.getElementById('btnDesconectar').disabled = !isConnected;
            document.getElementById('btnCrear').disabled = !isConnected;
            document.getElementById('btnListar').disabled = !isConnected;
            document.getElementById('btnCustom').disabled = !isConnected;
        }
        
        function conectar() {
            const testUser = document.getElementById('testUser').value.trim() + Date.now();
            if (!testUser) {
                log('‚ùå ERROR: Nombre de usuario requerido', 'error');
                return;
            }
            
            log('üîå Iniciando conexi√≥n Socket.IO...', 'info');
            actualizarEstado('Conectando');
            
            // Generar IDs √∫nicos
            userId = 'debug_' + Date.now();
            localStorage.setItem('userId', userId);
            localStorage.setItem('username', testUser);
            document.getElementById('userId').textContent = userId;
            
            try {
                socket = io('https://maira-3e76.onrender.com', {
                    transports: ['polling', 'websocket'],
                    timeout: 30000,
                    reconnection: true,
                    reconnectionDelay: 2000,
                    reconnectionAttempts: 5,
                    forceNew: true
                });
                
                configurarEventos();
                
            } catch (error) {
                log(`‚ùå ERROR al crear socket: ${error.message}`, 'error');
                contadores.errores++;
                actualizarContadores();
                actualizarEstado('Desconectado');
            }
        }
        
        function configurarEventos() {
            // Eventos de conexi√≥n
            socket.on('connect', () => {
                log(`‚úÖ CONECTADO - Socket ID: ${socket.id}`, 'success');
                actualizarEstado('Conectado', socket.id);
                
                // Auto-login con datos completos
                const userData = {
                    user_id: userId,
                    username: document.getElementById('testUser').value
                };
                
                log(`üë§ Enviando login: ${JSON.stringify(userData)}`, 'info');
                socket.emit('login', userData);
                contadores.enviados++;
                actualizarContadores();
            });
            
            socket.on('disconnect', (razon) => {
                log(`‚ùå DESCONECTADO - Raz√≥n: ${razon}`, 'error');
                actualizarEstado('Desconectado');
                contadores.errores++;
                actualizarContadores();
            });
            
            socket.on('connect_error', (error) => {
                log(`‚ùå ERROR DE CONEXI√ìN: ${error.message}`, 'error');
                contadores.errores++;
                actualizarContadores();
            });
            
            // Eventos espec√≠ficos
            socket.on('loginExitoso', (data) => {
                log(`‚úÖ LOGIN EXITOSO: ${JSON.stringify(data)}`, 'success');
                contadores.recibidos++;
                actualizarContadores();
            });
            
            socket.on('loginError', (error) => {
                log(`‚ùå LOGIN ERROR: ${error.mensaje}`, 'error');
                log(`   SOLUCI√ìN: Verificar que los datos de login sean completos`, 'warning');
                contadores.errores++;
                actualizarContadores();
            });
            
            socket.on('partidaCreada', (partida) => {
                log(`üéØ PARTIDA CREADA EXITOSAMENTE:`, 'success');
                log(`   - C√≥digo: ${partida.codigo}`, 'success');
                log(`   - ID: ${partida.id}`, 'success');
                log(`   - Estado: ${partida.estado}`, 'success');
                log(`   - Jugadores: ${partida.jugadores?.length || 0}`, 'success');
                
                partidaActual = partida;
                document.getElementById('partidaInfo').innerHTML = `
                    <strong>C√≥digo:</strong> ${partida.codigo}<br>
                    <strong>Nombre:</strong> ${partida.configuracion?.nombrePartida || 'Sin nombre'}<br>
                    <strong>Estado:</strong> ${partida.estado}
                `;
                
                contadores.recibidos++;
                actualizarContadores();
            });
            
            socket.on('errorCrearPartida', (error) => {
                log(`‚ùå ERROR AL CREAR PARTIDA: ${error.mensaje}`, 'error');
                contadores.errores++;
                actualizarContadores();
            });
            
            socket.on('partidasDisponibles', (data) => {
                log(`üìã PARTIDAS DISPONIBLES: ${data.partidas?.length || 0} partidas`, 'info');
                contadores.recibidos++;
                actualizarContadores();
            });
            
            // Capturar todos los eventos
            const eventoOriginal = socket.onevent;
            socket.onevent = function(packet) {
                const args = packet.data || [];
                const eventName = args[0];
                
                if (!['connect', 'disconnect', 'loginExitoso', 'partidaCreada', 'errorCrearPartida', 'partidasDisponibles'].includes(eventName)) {
                    log(`üì® EVENTO: ${eventName} -> ${JSON.stringify(args.slice(1))}`, 'info');
                    contadores.recibidos++;
                    actualizarContadores();
                }
                
                return eventoOriginal.call(this, packet);
            };
        }
        
        function crearPartida() {
            if (!socket || !socket.connected) {
                log('‚ùå ERROR: Socket no conectado', 'error');
                return;
            }
            
            const configuracion = {
                nombrePartida: document.getElementById('nombrePartida').value,
                duracionPartida: parseInt(document.getElementById('duracionPartida').value),
                duracionTurno: parseInt(document.getElementById('duracionTurno').value),
                objetivoPartida: document.getElementById('objetivoPartida').value,
                modo: 'internet',
                creadorId: userId
            };
            
            log(`üéØ ENVIANDO CREAR PARTIDA:`, 'info');
            log(`   ${JSON.stringify(configuracion, null, 2)}`, 'info');
            
            socket.emit('crearPartida', { configuracion });
            contadores.enviados++;
            actualizarContadores();
        }
        
        function obtenerPartidas() {
            if (!socket || !socket.connected) {
                log('‚ùå ERROR: Socket no conectado', 'error');
                return;
            }
            
            log('üìã Solicitando partidas disponibles...', 'info');
            socket.emit('obtenerPartidasDisponibles');
            contadores.enviados++;
            actualizarContadores();
        }
        
        function enviarCustom() {
            if (!socket || !socket.connected) {
                log('‚ùå ERROR: Socket no conectado', 'error');
                return;
            }
            
            try {
                const data = JSON.parse(document.getElementById('jsonData').value || '{}');
                log(`üì§ ENVIANDO CUSTOM: ${JSON.stringify(data)}`, 'info');
                
                // Si hay un evento espec√≠fico en el JSON, usar ese
                if (data.evento) {
                    socket.emit(data.evento, data.datos || data);
                } else {
                    socket.emit('crearPartida', data);
                }
                
                contadores.enviados++;
                actualizarContadores();
            } catch (error) {
                log(`‚ùå ERROR JSON: ${error.message}`, 'error');
                contadores.errores++;
                actualizarContadores();
            }
        }
        
        function desconectar() {
            if (socket) {
                log('‚ùå Desconectando...', 'warning');
                socket.disconnect();
                socket = null;
                partidaActual = null;
                document.getElementById('partidaInfo').innerHTML = 'Sin partida activa';
                actualizarEstado('Desconectado');
            }
        }
        
        function limpiarLog() {
            document.getElementById('logArea').innerHTML = '';
            contadores = { enviados: 0, recibidos: 0, errores: 0 };
            actualizarContadores();
        }
        
        // Inicializaci√≥n
        window.addEventListener('load', () => {
            log('üöÄ Debug Client iniciado', 'info');
            log('üìù Usar este cliente para diagnosticar problemas de Socket.IO', 'info');
            
            // Pre-llenar usuario √∫nico
            document.getElementById('testUser').value = 'DebugUser_' + Date.now();
        });
        
        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (socket) socket.disconnect();
        });
    </script>
</body>
</html>
