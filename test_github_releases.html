<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ… MAIRA - Test de GitHub Releases</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0f4c75, #3282b8, #bbe1fa);
            color: #ffffff;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 50px rgba(0,255,0,0.3);
            border: 2px solid #00ff00;
        }
        .status-ok { color: #00ff00; font-weight: bold; }
        .status-error { color: #ff4444; font-weight: bold; }
        .status-warning { color: #ffaa00; font-weight: bold; }
        .status-pending { color: #00aaff; font-weight: bold; }
        .test-section {
            background: rgba(0,40,0,0.9);
            border: 2px solid #00ff00;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .btn {
            background: linear-gradient(45deg, #00ff00, #00aa00);
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: linear-gradient(45deg, #00aa00, #007700);
            transform: scale(1.05);
        }
        .log {
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            margin: 15px 0;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            border-radius: 5px;
            border-left: 4px solid #00ff00;
        }
        .url-test {
            background: #222;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 3px solid #00aaff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âœ… MAIRA - Test de GitHub Releases</h1>
        <p>VerificaciÃ³n de tiles desde GitHub Releases + JSDelivr CDN</p>

        <!-- Estado de URLs -->
        <div class="test-section">
            <h3>ğŸ”— Test de URLs de GitHub Releases</h3>
            <div id="urlStatus"></div>
            <button class="btn" onclick="testUrls()">ğŸ”„ Probar URLs</button>
            <button class="btn" onclick="testCDN()">ğŸŒ Probar CDN</button>
        </div>

        <!-- ConfiguraciÃ³n AutomÃ¡tica -->
        <div class="test-section">
            <h3>âš™ï¸ ConfiguraciÃ³n AutomÃ¡tica</h3>
            <div id="configStatus" class="status-pending">â³ Inicializando...</div>
            <button class="btn" onclick="forceConfig()">ğŸ”§ Forzar ConfiguraciÃ³n</button>
            <button class="btn" onclick="switchToDirect()">ğŸ“¦ Usar GitHub Directo</button>
            <button class="btn" onclick="switchToCDN()">ğŸŒ Usar CDN</button>
        </div>

        <!-- Test de Adaptador -->
        <div class="test-section">
            <h3>ğŸ—ºï¸ Test del Adaptador de Tiles</h3>
            <div id="adapterStatus" class="status-pending">â³ Verificando adaptador...</div>
            <button class="btn" onclick="testAdapter()">ğŸ§ª Test Adaptador</button>
            <button class="btn" onclick="clearCache()">ğŸ—‘ï¸ Limpiar Cache</button>
        </div>

        <!-- Log de Actividad -->
        <div class="test-section">
            <h3>ğŸ“‹ Log de Actividad</h3>
            <div id="activityLog" class="log"></div>
            <button class="btn" onclick="clearLog()">ğŸ§¹ Limpiar Log</button>
        </div>

        <!-- Enlaces de Prueba -->
        <div class="test-section">
            <h3>ğŸš€ Enlaces de Prueba</h3>
            <button class="btn" onclick="window.open('planeamiento.html', '_blank')">ğŸ“‹ Probar Planeamiento</button>
            <button class="btn" onclick="window.open('juegodeguerra.html', '_blank')">âš”ï¸ Probar Juego Guerra</button>
            <button class="btn" onclick="window.open('estado_sistema_maira.html', '_blank')">ğŸ“Š Estado Sistema</button>
        </div>
    </div>

    <!-- Cargar adaptadores y configuraciÃ³n -->
    <script src="external_tiles_adapter.js"></script>
    <script src="github_releases_config.js"></script>
    <script src="temporary_tiles_solution.js"></script>

    <script>
        let logContainer;
        
        // URLs a probar
        const TEST_URLS = {
            direct: {
                manifest: 'https://github.com/Ehr051/MAIRA/releases/download/tiles-v1.0/files_manifest.json',
                altimetria: 'https://github.com/Ehr051/MAIRA/releases/download/tiles-v1.0/altimetria_tiles.tar.gz',
                vegetacion: 'https://github.com/Ehr051/MAIRA/releases/download/tiles-v1.0/vegetacion_part_aa.tar.gz'
            },
            cdn: {
                manifest: 'https://cdn.jsdelivr.net/gh/Ehr051/MAIRA@tiles-v1.0/files_manifest.json',
                altimetria: 'https://cdn.jsdelivr.net/gh/Ehr051/MAIRA@tiles-v1.0/altimetria_tiles.tar.gz',
                vegetacion: 'https://cdn.jsdelivr.net/gh/Ehr051/MAIRA@tiles-v1.0/vegetacion_part_aa.tar.gz'
            }
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            const logMessage = `[${timestamp}] ${emoji} ${message}`;
            
            console.log(logMessage);
            
            if (logContainer) {
                logContainer.innerHTML += logMessage + '\n';
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        async function testUrls() {
            log('ğŸ” Probando URLs de GitHub Releases...');
            const urlContainer = document.getElementById('urlStatus');
            urlContainer.innerHTML = '';

            for (const [type, urls] of Object.entries(TEST_URLS)) {
                const typeDiv = document.createElement('div');
                typeDiv.className = 'url-test';
                typeDiv.innerHTML = `<h4>${type === 'direct' ? 'ğŸ“¦ GitHub Directo' : 'ğŸŒ CDN JSDelivr'}</h4>`;

                for (const [name, url] of Object.entries(urls)) {
                    try {
                        log(`Probando ${type} ${name}: ${url}`);
                        const response = await fetch(url, { method: 'HEAD' });
                        const status = response.ok ? 'status-ok' : 'status-error';
                        const statusText = response.ok ? 'âœ… OK' : `âŒ ${response.status}`;
                        
                        typeDiv.innerHTML += `<div><strong>${name}:</strong> <span class="${status}">${statusText}</span></div>`;
                        log(`${name} (${type}): ${statusText}`, response.ok ? 'success' : 'error');
                    } catch (error) {
                        typeDiv.innerHTML += `<div><strong>${name}:</strong> <span class="status-error">âŒ Error</span></div>`;
                        log(`${name} (${type}): Error - ${error.message}`, 'error');
                    }
                }

                urlContainer.appendChild(typeDiv);
            }
        }

        async function testCDN() {
            log('ğŸŒ Test especÃ­fico del CDN JSDelivr...');
            
            try {
                const response = await fetch(TEST_URLS.cdn.manifest);
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… CDN JSDelivr funcionando - Manifest cargado', 'success');
                    console.log('ğŸ“Š Datos del manifest:', data);
                    
                    if (window.updateTilesStatus) {
                        window.updateTilesStatus('CDN JSDelivr activo - tiles disponibles', 'success');
                    }
                } else {
                    log('âš ï¸ CDN aÃºn no disponible, usando GitHub directo', 'warning');
                }
            } catch (error) {
                log('âš ï¸ CDN no disponible: ' + error.message, 'warning');
                log('ğŸ“¦ Usando URLs directas de GitHub', 'info');
            }
        }

        function forceConfig() {
            log('ğŸ”§ Forzando configuraciÃ³n automÃ¡tica...');
            
            if (window.githubReleasesConfig) {
                window.githubReleasesConfig.configure().then(success => {
                    if (success) {
                        log('âœ… ConfiguraciÃ³n forzada exitosa', 'success');
                        document.getElementById('configStatus').innerHTML = 
                            '<span class="status-ok">âœ… GitHub Releases configurado</span>';
                    } else {
                        log('âš ï¸ ConfiguraciÃ³n pendiente', 'warning');
                    }
                });
            }
        }

        function switchToDirect() {
            log('ğŸ“¦ Cambiando a URLs directas de GitHub...');
            if (window.externalTilesAdapter) {
                window.externalTilesAdapter.switchStorageProvider('github_releases_direct');
                log('âœ… Cambiado a GitHub directo', 'success');
            }
        }

        function switchToCDN() {
            log('ğŸŒ Cambiando a CDN JSDelivr...');
            if (window.externalTilesAdapter) {
                window.externalTilesAdapter.switchStorageProvider('github_releases_cdn');
                log('âœ… Cambiado a CDN JSDelivr', 'success');
            }
        }

        function testAdapter() {
            log('ğŸ§ª Probando adaptador de tiles...');
            
            if (window.externalTilesAdapter) {
                const diagnosis = window.externalTilesAdapter.diagnoseStorageAccess();
                
                document.getElementById('adapterStatus').innerHTML = `
                    <div class="status-ok">âœ… Adaptador funcionando</div>
                    <div>Proveedor: ${diagnosis.current_provider}</div>
                    <div>Base URL: ${diagnosis.base_url}</div>
                    <div>Cache: ${diagnosis.cache_status.tiles_cached} tiles, ${diagnosis.cache_status.indices_cached} Ã­ndices</div>
                `;
                
                log('âœ… Adaptador funcionando correctamente', 'success');
                log(`ğŸ“Š Proveedor: ${diagnosis.current_provider}`);
                log(`ğŸŒ URL: ${diagnosis.base_url}`);
            } else {
                document.getElementById('adapterStatus').innerHTML = 
                    '<span class="status-error">âŒ Adaptador no disponible</span>';
                log('âŒ Adaptador no disponible', 'error');
            }
        }

        function clearCache() {
            if (window.externalTilesAdapter) {
                window.externalTilesAdapter.clearCache();
                log('ğŸ—‘ï¸ Cache limpiado', 'info');
            }
        }

        function clearLog() {
            if (logContainer) {
                logContainer.innerHTML = '';
            }
        }

        // InicializaciÃ³n
        document.addEventListener('DOMContentLoaded', function() {
            logContainer = document.getElementById('activityLog');
            log('ğŸš€ Test de GitHub Releases iniciado');
            
            // Test inicial automÃ¡tico
            setTimeout(testUrls, 1000);
            setTimeout(testCDN, 3000);
            setTimeout(testAdapter, 5000);
        });

        // Escuchar eventos
        window.addEventListener('githubReleasesReady', function(e) {
            log('ğŸ‰ GitHub Releases configurado automÃ¡ticamente!', 'success');
            log(`ğŸŒ Usando: ${e.detail.useCDN ? 'CDN JSDelivr' : 'GitHub directo'}`);
            
            document.getElementById('configStatus').innerHTML = 
                `<span class="status-ok">âœ… GitHub Releases listo (${e.detail.useCDN ? 'CDN' : 'Directo'})</span>`;
        });

        window.addEventListener('storageProviderChanged', function(e) {
            log(`ğŸ”„ Proveedor cambiado a: ${e.detail.provider}`, 'info');
            log(`ğŸ“ Nueva URL base: ${e.detail.baseUrl}`);
        });
    </script>
</body>
</html>
