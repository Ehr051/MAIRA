/**
 * üéØ MAIRA CORE - Sistema Central Unificado
 * Gestiona la estructura base para todos los modos
 * Rutas, navegaci√≥n, estado global y comunicaci√≥n entre m√≥dulos
 */

class MAIRACore {
    constructor() {
        this.version = '4.0.0';
        this.modoActual = null;
        this.usuarioActual = null;
        this.configuracionGlobal = null;
        this.estadoGlobal = {};
        this.gestores = new Map();
        this.rutas = new Map();
        this.eventBus = new EventTarget();
        
        console.log('üéØ MAIRA Core 4.0 inicializado');
        this.inicializarCore();
    }

    /**
     * INICIALIZAR CORE SYSTEM
     */
    inicializarCore() {
        this.configurarRutas();
        this.configurarGestores();
        this.configurarEventos();
        this.cargarConfiguracionGlobal();
        
        console.log('‚úÖ MAIRA Core configurado');
    }

    /**
     * CONFIGURAR RUTAS UNIFICADAS
     */
    configurarRutas() {
        // Rutas principales del sistema
        this.rutas.set('landing', {
            path: 'index.html',
            titulo: 'MAIRA - Sistema de Entrenamiento Militar',
            modulo: 'landing',
            requiereAuth: false
        });

        this.rutas.set('login', {
            path: 'index.html#login',
            titulo: 'Iniciar Sesi√≥n',
            modulo: 'auth',
            requiereAuth: false
        });

        this.rutas.set('seleccionModo', {
            path: 'index.html#modos',
            titulo: 'Selecci√≥n de Modo',
            modulo: 'selector',
            requiereAuth: true
        });

        // Modos principales
        this.rutas.set('planeamiento', {
            path: 'planeamiento.html',
            titulo: 'Modo Planeamiento',
            modulo: 'planeamiento',
            requiereAuth: true,
            gestor: 'PlaneamientoManager'
        });

        this.rutas.set('iniciarpartida', {
            path: 'iniciarpartida.html',
            titulo: 'Simulador T√°ctico',
            modulo: 'simulador',
            requiereAuth: true,
            gestor: 'SimuladorManager'
        });

        this.rutas.set('juegodeguerra', {
            path: 'juegodeguerra.html',
            titulo: 'Juego de Guerra',
            modulo: 'combate',
            requiereAuth: true,
            gestor: 'GestorJuego'
        });

        this.rutas.set('CO', {
            path: 'CO.html',
            titulo: 'Cuadro de Organizaci√≥n',
            modulo: 'organizacion',
            requiereAuth: true,
            gestor: 'COManager'
        });

        this.rutas.set('GB', {
            path: 'inicioGB.html',
            titulo: 'Gesti√≥n de Batalla',
            modulo: 'batalla',
            requiereAuth: true,
            gestor: 'GBManager'
        });

        console.log('üó∫Ô∏è Rutas configuradas:', this.rutas.size);
    }

    /**
     * CONFIGURAR GESTORES CORE
     */
    configurarGestores() {
        // Gestores globales disponibles para todos los modos
        this.gestores.set('UserIdentity', null);
        this.gestores.set('SessionManager', null);
        this.gestores.set('CommunicationManager', null);
        this.gestores.set('StateManager', null);
        
        // Gestores espec√≠ficos por modo
        this.gestores.set('PlaneamientoManager', null);
        this.gestores.set('SimuladorManager', null);
        this.gestores.set('GestorJuego', null);
        this.gestores.set('COManager', null);
        this.gestores.set('GBManager', null);
        
        console.log('‚öôÔ∏è Gestores registrados:', this.gestores.size);
    }

    /**
     * NAVEGACI√ìN ENTRE MODOS
     */
    navegarA(ruta, parametros = {}) {
        const rutaInfo = this.rutas.get(ruta);
        
        if (!rutaInfo) {
            console.error('‚ùå Ruta no encontrada:', ruta);
            return false;
        }

        // Verificar autenticaci√≥n
        if (rutaInfo.requiereAuth && !this.usuarioAutenticado()) {
            console.warn('‚ö†Ô∏è Ruta requiere autenticaci√≥n, redirigiendo a login');
            this.navegarA('login');
            return false;
        }

        // Guardar estado actual antes de cambiar
        this.guardarEstadoActual();

        // Cambiar de modo
        this.cambiarModo(rutaInfo.modulo, parametros);

        // Navegar f√≠sicamente
        if (window.location.pathname !== rutaInfo.path) {
            window.location.href = rutaInfo.path;
        }

        return true;
    }

    /**
     * CAMBIAR MODO ACTIVO
     */
    cambiarModo(nuevoModo, parametros = {}) {
        const modoAnterior = this.modoActual;
        
        // Limpiar modo anterior
        if (modoAnterior && this.gestores.has(modoAnterior)) {
            this.limpiarModo(modoAnterior);
        }

        // Establecer nuevo modo
        this.modoActual = nuevoModo;
        this.estadoGlobal.modoActual = nuevoModo;
        this.estadoGlobal.parametros = parametros;

        // Emitir evento de cambio
        this.emitirEvento('modoChanged', {
            anterior: modoAnterior,
            actual: nuevoModo,
            parametros: parametros
        });

        console.log(`üîÑ Modo cambiado: ${modoAnterior} ‚Üí ${nuevoModo}`);
    }

    /**
     * GESTI√ìN DE ESTADO GLOBAL
     */
    obtenerEstado(clave) {
        return this.estadoGlobal[clave];
    }

    establecerEstado(clave, valor) {
        const valorAnterior = this.estadoGlobal[clave];
        this.estadoGlobal[clave] = valor;

        this.emitirEvento('estadoChanged', {
            clave: clave,
            valorAnterior: valorAnterior,
            valorNuevo: valor
        });
    }

    /**
     * GESTI√ìN DE USUARIOS
     */
    usuarioAutenticado() {
        return this.usuarioActual !== null && 
               this.gestores.get('UserIdentity')?.isAuthenticated?.() === true;
    }

    establecerUsuario(userData) {
        this.usuarioActual = userData;
        this.estadoGlobal.usuario = userData;
        
        this.emitirEvento('usuarioChanged', userData);
        
        console.log('üë§ Usuario establecido:', userData.username);
    }

    /**
     * COMUNICACI√ìN ENTRE GESTORES
     */
    registrarGestor(nombre, instancia) {
        this.gestores.set(nombre, instancia);
        
        console.log(`üìù Gestor registrado: ${nombre}`);
        
        this.emitirEvento('gestorRegistrado', {
            nombre: nombre,
            instancia: instancia
        });
    }

    obtenerGestor(nombre) {
        return this.gestores.get(nombre);
    }

    /**
     * SISTEMA DE EVENTOS GLOBAL
     */
    emitirEvento(tipoEvento, datos) {
        const evento = new CustomEvent(tipoEvento, {
            detail: {
                timestamp: new Date().toISOString(),
                datos: datos
            }
        });
        
        this.eventBus.dispatchEvent(evento);
        
        console.log(`üì° Evento emitido: ${tipoEvento}`, datos);
    }

    escucharEvento(tipoEvento, callback) {
        this.eventBus.addEventListener(tipoEvento, callback);
    }

    /**
     * CONFIGURACI√ìN GLOBAL
     */
    cargarConfiguracionGlobal() {
        // Configuraci√≥n default
        this.configuracionGlobal = {
            servidor: {
                url: window.SERVER_URL || 'http://localhost:3000',
                timeout: 30000
            },
            mapa: {
                centroDefault: [-34.9964963, -64.9672817],
                zoomDefault: 4,
                tilesPath: '/tiles'
            },
            juego: {
                duracionTurnoDefault: 300,
                maxJugadores: 6,
                equipos: ['azul', 'rojo']
            },
            interfaz: {
                tema: 'claro',
                idioma: 'es',
                notificaciones: true
            }
        };

        // Cargar desde localStorage si existe
        const configGuardada = localStorage.getItem('maira_config_global');
        if (configGuardada) {
            try {
                const config = JSON.parse(configGuardada);
                this.configuracionGlobal = { ...this.configuracionGlobal, ...config };
            } catch (error) {
                console.warn('‚ö†Ô∏è Error cargando configuraci√≥n guardada:', error);
            }
        }

        console.log('‚öôÔ∏è Configuraci√≥n global cargada');
    }

    guardarConfiguracionGlobal() {
        localStorage.setItem('maira_config_global', JSON.stringify(this.configuracionGlobal));
        console.log('üíæ Configuraci√≥n global guardada');
    }

    /**
     * UTILIDADES CORE
     */
    limpiarModo(modo) {
        const gestor = this.gestores.get(modo);
        if (gestor && typeof gestor.limpiar === 'function') {
            gestor.limpiar();
        }
    }

    guardarEstadoActual() {
        const estado = {
            modo: this.modoActual,
            usuario: this.usuarioActual,
            timestamp: new Date().toISOString(),
            url: window.location.href
        };
        
        sessionStorage.setItem('maira_estado_anterior', JSON.stringify(estado));
    }

    restaurarEstadoAnterior() {
        const estadoString = sessionStorage.getItem('maira_estado_anterior');
        if (estadoString) {
            try {
                const estado = JSON.parse(estadoString);
                return estado;
            } catch (error) {
                console.warn('‚ö†Ô∏è Error restaurando estado anterior:', error);
            }
        }
        return null;
    }

    /**
     * CONFIGURAR EVENTOS CORE
     */
    configurarEventos() {
        // Eventos de navegaci√≥n del navegador
        window.addEventListener('beforeunload', () => {
            this.guardarEstadoActual();
            this.guardarConfiguracionGlobal();
        });

        // Eventos de error global
        window.addEventListener('error', (event) => {
            console.error('‚ùå Error global capturado:', event.error);
            this.emitirEvento('errorGlobal', {
                mensaje: event.message,
                archivo: event.filename,
                linea: event.lineno,
                error: event.error
            });
        });

        console.log('üîó Eventos core configurados');
    }

    /**
     * INFORMACI√ìN DEL SISTEMA
     */
    obtenerInfoSistema() {
        return {
            version: this.version,
            modoActual: this.modoActual,
            usuario: this.usuarioActual?.username,
            gestoresActivos: Array.from(this.gestores.keys()).filter(
                key => this.gestores.get(key) !== null
            ),
            rutasDisponibles: Array.from(this.rutas.keys()),
            estadoGlobal: { ...this.estadoGlobal }
        };
    }
}

// Crear instancia global
if (typeof window !== 'undefined') {
    window.MAIRA = window.MAIRA || {};
    window.MAIRA.Core = new MAIRACore();
    
    console.log('üåü MAIRA Core 4.0 disponible globalmente');
}

// Export para Node.js
if (typeof module !== 'undefined' && module.exports) {
    module.exports = MAIRACore;
}
