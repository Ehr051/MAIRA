/**
 * SCRIPT DE VERIFICACI√ìN COMPLETA - M√ìDULO GESTI√ìN DE BATALLA
 * Verifica todas las funcionalidades del m√≥dulo de gesti√≥n de batalla
 * @version 1.0.0
 */

class TestGestionBatalla {
    constructor() {
        this.resultados = {};
        this.errores = [];
        this.timeouts = [];
        this.testActual = '';
    }

    /**
     * Ejecuta todos los tests del m√≥dulo de gesti√≥n de batalla
     */
    async ejecutarTodosLosTests() {
        console.log('üß™ INICIANDO VERIFICACI√ìN COMPLETA DEL M√ìDULO GESTI√ìN DE BATALLA');
        console.log('‚ïê'.repeat(60));
        
        const tests = [
            'verificarInicializacion',
            'verificarMapa',
            'verificarElementosGB',
            'verificarSocket',
            'verificarChat',
            'verificarInformes',
            'verificarPosicionamiento',
            'verificarElementosConectados',
            'verificarEdicionGB',
            'verificarUtilsGB',
            'verificarExportacion',
            'verificarIntegracionCompleta'
        ];

        let pasados = 0;
        let fallados = 0;

        for (const test of tests) {
            try {
                this.testActual = test;
                const resultado = await this[test]();
                this.resultados[test] = resultado;
                
                if (resultado.exito) {
                    pasados++;
                    console.log(`‚úÖ ${test}: ${resultado.mensaje}`);
                } else {
                    fallados++;
                    console.log(`‚ùå ${test}: ${resultado.mensaje}`);
                    this.errores.push(`${test}: ${resultado.mensaje}`);
                }
            } catch (error) {
                fallados++;
                console.error(`üí• ${test} FALL√ì CON ERROR:`, error);
                this.errores.push(`${test}: ${error.message}`);
            }
        }

        this.mostrarResumenFinal(pasados, fallados);
        return { pasados, fallados, errores: this.errores };
    }

    /**
     * Test 1: Verificar inicializaci√≥n del m√≥dulo
     */
    async verificarInicializacion() {
        const checks = {
            'DOM cargado': !!document.querySelector('body'),
            'MAIRA namespace': !!window.MAIRA,
            'MAIRA.GestionBatalla': !!window.MAIRA?.GestionBatalla,
            'Socket.io cargado': typeof io !== 'undefined',
            'milsymbol disponible': typeof window.ms !== 'undefined',
            'Variables globales GB': !!(window.elementosConectados !== undefined && window.usuarioInfo !== undefined),
            'Mapa inicializado': !!window.mapa
        };

        const fallidas = Object.entries(checks).filter(([key, value]) => !value);
        
        if (fallidas.length === 0) {
            return { exito: true, mensaje: 'Inicializaci√≥n completa ‚úì' };
        } else {
            return { 
                exito: false, 
                mensaje: `Fallas en inicializaci√≥n: ${fallidas.map(([k]) => k).join(', ')}` 
            };
        }
    }

    /**
     * Test 2: Verificar funcionamiento del mapa
     */
    async verificarMapa() {
        if (!window.mapa) {
            return { exito: false, mensaje: 'Mapa no inicializado' };
        }

        const checks = {
            'Mapa renderizado': !!window.mapa._container,
            'Centro configurado': !!window.mapa.getCenter(),
            'Zoom configurado': window.mapa.getZoom() > 0,
            'Capas base': Object.keys(window.mapa._layers).length > 0,
            'Controles activos': !!document.querySelector('.leaflet-control'),
            'Eventos de mapa': !!window.mapa._events?.click
        };

        const fallidas = Object.entries(checks).filter(([key, value]) => !value);
        
        if (fallidas.length === 0) {
            return { exito: true, mensaje: 'Mapa funcionando correctamente ‚úì' };
        } else {
            return { 
                exito: false, 
                mensaje: `Problemas en mapa: ${fallidas.map(([k]) => k).join(', ')}` 
            };
        }
    }

    /**
     * Test 3: Verificar elementos de gesti√≥n de batalla
     */
    async verificarElementosGB() {
        const elementos = {
            'elementosGB.js cargado': !!document.querySelector('script[src*="elementosGB"]'),
            'Panel elementos': !!document.getElementById('tab-elementos'),
            'Lista elementos conectados': !!document.getElementById('elementosConectados'),
            'Funciones GB disponibles': !!(window.MAIRA?.GestionBatalla?.agregarElemento || typeof window.agregarElemento === 'function')
        };

        const fallidas = Object.entries(elementos).filter(([key, value]) => !value);
        
        if (fallidas.length === 0) {
            return { exito: true, mensaje: 'Elementos GB disponibles ‚úì' };
        } else {
            return { 
                exito: false, 
                mensaje: `Elementos GB faltantes: ${fallidas.map(([k]) => k).join(', ')}` 
            };
        }
    }

    /**
     * Test 4: Verificar conexi√≥n Socket.io
     */
    async verificarSocket() {
        const elementos = {
            'Socket.io librer√≠a': typeof io !== 'undefined',
            'Socket global': !!window.socket || !!window.MAIRA?.GestionBatalla?.socket,
            'Configuraci√≥n socket': !!window.MAIRA?.GestionBatalla?.configurarSocket,
            'Event listeners': !!(window.MAIRA?.GestionBatalla && typeof window.MAIRA.GestionBatalla.configurarEventosSocket === 'function')
        };

        const fallidas = Object.entries(elementos).filter(([key, value]) => !value);
        
        if (fallidas.length <= 1) { // Permitir 1 falla (conexi√≥n puede no estar activa)
            return { exito: true, mensaje: 'Sistema Socket disponible ‚úì' };
        } else {
            return { 
                exito: false, 
                mensaje: `Problemas en Socket: ${fallidas.map(([k]) => k).join(', ')}` 
            };
        }
    }

    /**
     * Test 5: Verificar sistema de chat
     */
    async verificarChat() {
        const elementos = {
            'Panel chat': !!document.getElementById('tab-chat'),
            'Input mensaje': !!document.getElementById('mensaje-chat'),
            '√Årea mensajes': !!document.getElementById('chat-messages'),
            'Bot√≥n enviar': !!document.getElementById('enviar-mensaje'),
            'Bot√≥n toggle panel': !!document.getElementById('toggle-panel-btn'),
            'Funciones chat': !!(window.enviarMensaje || window.MAIRA?.GestionBatalla?.enviarMensaje)
        };

        const fallidas = Object.entries(elementos).filter(([key, value]) => !value);
        
        if (fallidas.length === 0) {
            return { exito: true, mensaje: 'Sistema de chat disponible ‚úì' };
        } else {
            return { 
                exito: false, 
                mensaje: `Problemas en chat: ${fallidas.map(([k]) => k).join(', ')}` 
            };
        }
    }

    /**
     * Test 6: Verificar sistema de informes
     */
    async verificarInformes() {
        const elementos = {
            'informesGB.js cargado': !!document.querySelector('script[src*="informesGB"]'),
            'Panel informes': !!document.getElementById('tab-informes'),
            'Panel lateral': !!document.getElementById('panel-lateral'),
            'Funciones informes': !!(window.crearInforme || window.MAIRA?.GestionBatalla?.crearInforme || window.MAIRA?.Informes)
        };

        const fallidas = Object.entries(elementos).filter(([key, value]) => !value);
        
        if (fallidas.length === 0) {
            return { exito: true, mensaje: 'Sistema de informes disponible ‚úì' };
        } else {
            return { 
                exito: false, 
                mensaje: `Problemas en informes: ${fallidas.map(([k]) => k).join(', ')}` 
            };
        }
    }

    /**
     * Test 7: Verificar posicionamiento y GPS
     */
    async verificarPosicionamiento() {
        const elementos = {
            'Geolocation API': !!navigator.geolocation,
            'Marcador usuario': !!(window.marcadorUsuario || window.MAIRA?.GestionBatalla?.marcadorUsuario),
            'Seguimiento GPS': !!(window.iniciarSeguimiento || window.MAIRA?.GestionBatalla?.iniciarSeguimiento),
            'Panel posici√≥n': !!document.querySelector('#posicionActual, .posicion-info')
        };

        const fallidas = Object.entries(elementos).filter(([key, value]) => !value);
        
        if (fallidas.length <= 1) { // Permitir 1 falla (GPS puede no estar disponible)
            return { exito: true, mensaje: 'Sistema de posicionamiento disponible ‚úì' };
        } else {
            return { 
                exito: false, 
                mensaje: `Problemas en posicionamiento: ${fallidas.map(([k]) => k).join(', ')}` 
            };
        }
    }

    /**
     * Test 8: Verificar elementos conectados
     */
    async verificarElementosConectados() {
        const elementos = {
            'elementosConectados global': window.elementosConectados !== undefined,
            'Lista UI elementos': !!document.getElementById('elementosConectados'),
            'Actualizar elementos': !!(window.actualizarElementosConectados || window.MAIRA?.GestionBatalla?.actualizarElementosConectados),
            'Mostrar/ocultar elementos': !!(window.toggleElemento || window.MAIRA?.GestionBatalla?.toggleElemento)
        };

        const fallidas = Object.entries(elementos).filter(([key, value]) => !value);
        
        if (fallidas.length === 0) {
            return { exito: true, mensaje: 'Gesti√≥n elementos conectados operativa ‚úì' };
        } else {
            return { 
                exito: false, 
                mensaje: `Problemas elementos conectados: ${fallidas.map(([k]) => k).join(', ')}` 
            };
        }
    }

    /**
     * Test 9: Verificar edici√≥n GB
     */
    async verificarEdicionGB() {
        const elementos = {
            'edicionGB.js cargado': !!document.querySelector('script[src*="edicionGB"]'),
            'Panel edici√≥n GB': !!document.querySelector('.panel-edicion-gb, #panelEdicionGB'),
            'Funciones edici√≥n': !!(window.editarElementoGB || window.MAIRA?.GestionBatalla?.editarElemento),
            'Guardar cambios': !!(window.guardarCambiosGB || window.MAIRA?.GestionBatalla?.guardarCambios)
        };

        const fallidas = Object.entries(elementos).filter(([key, value]) => !value);
        
        if (fallidas.length <= 1) {
            return { exito: true, mensaje: 'Sistema de edici√≥n GB disponible ‚úì' };
        } else {
            return { 
                exito: false, 
                mensaje: `Problemas en edici√≥n GB: ${fallidas.map(([k]) => k).join(', ')}` 
            };
        }
    }

    /**
     * Test 10: Verificar utilidades GB
     */
    async verificarUtilsGB() {
        const elementos = {
            'utilsGB.js cargado': !!document.querySelector('script[src*="utilsGB"]'),
            'Exportar datos': !!(window.exportarDatos || window.MAIRA?.GestionBatalla?.exportarDatos),
            'Validar elementos': !!(window.validarElemento || window.MAIRA?.GestionBatalla?.validarElemento),
            'Formatear datos': !!(window.formatearDatos || window.MAIRA?.GestionBatalla?.formatearDatos)
        };

        const fallidas = Object.entries(elementos).filter(([key, value]) => !value);
        
        if (fallidas.length <= 1) {
            return { exito: true, mensaje: 'Utilidades GB disponibles ‚úì' };
        } else {
            return { 
                exito: false, 
                mensaje: `Problemas en utilidades GB: ${fallidas.map(([k]) => k).join(', ')}` 
            };
        }
    }

    /**
     * Test 11: Verificar exportaci√≥n
     */
    async verificarExportacion() {
        const elementos = {
            'jsPDF disponible': !!(window.jspdf || window.jsPDF),
            'html2canvas disponible': typeof window.html2canvas !== 'undefined',
            'Exportar PDF': !!(window.exportarPDF || window.MAIRA?.GestionBatalla?.exportarPDF),
            'Exportar imagen': !!(window.exportarImagen || window.MAIRA?.GestionBatalla?.exportarImagen)
        };

        const fallidas = Object.entries(elementos).filter(([key, value]) => !value);
        
        if (fallidas.length <= 1) {
            return { exito: true, mensaje: 'Capacidades de exportaci√≥n disponibles ‚úì' };
        } else {
            return { 
                exito: false, 
                mensaje: `Problemas en exportaci√≥n: ${fallidas.map(([k]) => k).join(', ')}` 
            };
        }
    }

    /**
     * Test 12: Verificar integraci√≥n completa
     */
    async verificarIntegracionCompleta() {
        const flujos = {
            'Conectar ‚Üí Mostrar en mapa': this.testFlujoConexion(),
            'Crear informe ‚Üí Enviar por socket': this.testFlujoInforme(),
            'Chat ‚Üí Comunicaci√≥n tiempo real': this.testFlujoChat(),
            'GPS ‚Üí Actualizar posici√≥n': this.testFlujoPosicion(),
            'Panel ‚Üí Toggle y notificaciones': this.testFlujoPanelCompleto()
        };

        let exitosos = 0;
        const resultados = {};

        for (const [flujo, test] of Object.entries(flujos)) {
            try {
                const resultado = await test;
                resultados[flujo] = resultado;
                if (resultado) exitosos++;
            } catch (error) {
                resultados[flujo] = false;
            }
        }

        if (exitosos >= 3) {
            return { exito: true, mensaje: 'Integraci√≥n entre m√≥dulos funcional ‚úì' };
        } else {
            return { 
                exito: false, 
                mensaje: `Fallos en integraci√≥n: ${Object.entries(resultados).filter(([k,v]) => !v).map(([k]) => k).join(', ')}` 
            };
        }
    }

    /**
     * Tests auxiliares para integraci√≥n
     */
    testFlujoConexion() {
        return !!(
            window.socket &&
            window.elementosConectados !== undefined &&
            (window.actualizarElementosConectados || window.MAIRA?.GestionBatalla?.actualizarElementosConectados)
        );
    }

    testFlujoInforme() {
        return !!(
            (window.crearInforme || window.MAIRA?.GestionBatalla?.crearInforme) &&
            window.socket &&
            document.getElementById('listaInformes')
        );
    }

    testFlujoChat() {
        return !!(
            (window.enviarMensaje || window.MAIRA?.GestionBatalla?.enviarMensaje) &&
            document.getElementById('mensajesArea') &&
            window.socket
        );
    }

    testFlujoPosicion() {
        return !!(
            navigator.geolocation &&
            (window.iniciarSeguimiento || window.MAIRA?.GestionBatalla?.iniciarSeguimiento) &&
            window.mapa
        );
    }

    testFlujoPanelCompleto() {
        return !!(
            document.getElementById('toggle-panel-btn') &&
            document.getElementById('panel-lateral') &&
            typeof window.MAIRA?.GestionBatalla?.togglePanel === 'function' &&
            document.querySelector('.tab-btn') &&
            document.getElementById('tab-chat')
        );
    }

    /**
     * Muestra el resumen final de todos los tests
     */
    mostrarResumenFinal(pasados, fallados) {
        console.log('\n' + '‚ïê'.repeat(60));
        console.log('üìä RESUMEN FINAL DE VERIFICACI√ìN - GESTI√ìN DE BATALLA');
        console.log('‚ïê'.repeat(60));
        console.log(`‚úÖ Tests pasados: ${pasados}`);
        console.log(`‚ùå Tests fallados: ${fallados}`);
        console.log(`üìà Porcentaje de √©xito: ${((pasados / (pasados + fallados)) * 100).toFixed(1)}%`);
        
        if (this.errores.length > 0) {
            console.log('\nüîç ERRORES ENCONTRADOS:');
            this.errores.forEach((error, index) => {
                console.log(`${index + 1}. ${error}`);
            });
        }

        console.log('\nüéØ RECOMENDACIONES:');
        if (pasados >= 10) {
            console.log('‚úÖ M√≥dulo de gesti√≥n de batalla en excelente estado');
            console.log('üí° Sistema listo para operaciones en tiempo real');
        } else if (pasados >= 8) {
            console.log('‚ö†Ô∏è  M√≥dulo funcional con algunos problemas menores');
            console.log('üîß Revisar conexiones de red y socket');
        } else if (pasados >= 6) {
            console.log('üîß M√≥dulo necesita correcciones importantes');
            console.log('‚ö° Priorizar: Socket, Chat e Informes');
        } else {
            console.log('üí• M√≥dulo requiere revisi√≥n completa');
            console.log('üö® Sistema no operativo para batalla');
        }
        
        console.log('‚ïê'.repeat(60));
    }

    /**
     * Ejecuta un test r√°pido (versi√≥n reducida)
     */
    async testRapido() {
        console.log('üöÄ EJECUTANDO TEST R√ÅPIDO DE GESTI√ìN DE BATALLA...');
        
        const testsBasicos = [
            'verificarInicializacion',
            'verificarMapa',
            'verificarSocket',
            'verificarChat',
            'verificarElementosGB'
        ];

        let exitosos = 0;
        for (const test of testsBasicos) {
            try {
                const resultado = await this[test]();
                if (resultado.exito) {
                    exitosos++;
                    console.log(`‚úÖ ${test}`);
                } else {
                    console.log(`‚ùå ${test}: ${resultado.mensaje}`);
                }
            } catch (error) {
                console.log(`üí• ${test}: ${error.message}`);
            }
        }

        console.log(`\nüìä RESULTADO: ${exitosos}/${testsBasicos.length} tests b√°sicos pasados`);
        return exitosos >= 3;
    }

    /**
     * Demo interactiva de funcionalidades
     */
    async demoFuncionalidades() {
        console.log('üéÆ INICIANDO DEMO INTERACTIVA DE GESTI√ìN DE BATALLA...');
        console.log('‚ïê'.repeat(60));
        
        if (!window.MAIRA?.GestionBatalla) {
            console.error('‚ùå MAIRA.GestionBatalla no disponible');
            return false;
        }

        const pasos = [
            {
                nombre: '1. Mostrar Panel',
                accion: () => {
                    if (window.MAIRA.GestionBatalla.togglePanel) {
                        window.MAIRA.GestionBatalla.togglePanel(true);
                        console.log('‚úÖ Panel mostrado');
                        return true;
                    }
                    return false;
                }
            },
            {
                nombre: '2. Enviar mensaje de prueba',
                accion: () => {
                    try {
                        if (window.MAIRA.GestionBatalla.agregarMensajeChat) {
                            window.MAIRA.GestionBatalla.agregarMensajeChat('Test', 'Mensaje de prueba desde demo', 'recibido');
                            console.log('‚úÖ Mensaje de prueba enviado');
                            return true;
                        }
                    } catch (error) {
                        console.error('‚ùå Error enviando mensaje:', error);
                    }
                    return false;
                }
            },
            {
                nombre: '3. Cambiar a pesta√±a Documentos',
                accion: () => {
                    try {
                        if (window.MAIRA.GestionBatalla.cambiarTab) {
                            window.MAIRA.GestionBatalla.cambiarTab('tab-informes');
                            console.log('‚úÖ Cambiado a pesta√±a Documentos');
                            return true;
                        }
                    } catch (error) {
                        console.error('‚ùå Error cambiando pesta√±a:', error);
                    }
                    return false;
                }
            },
            {
                nombre: '4. Volver a Chat',
                accion: () => {
                    try {
                        if (window.MAIRA.GestionBatalla.cambiarTab) {
                            window.MAIRA.GestionBatalla.cambiarTab('tab-chat');
                            console.log('‚úÖ Cambiado a pesta√±a Chat');
                            return true;
                        }
                    } catch (error) {
                        console.error('‚ùå Error cambiando pesta√±a:', error);
                    }
                    return false;
                }
            },
            {
                nombre: '5. Ocultar Panel',
                accion: () => {
                    if (window.MAIRA.GestionBatalla.togglePanel) {
                        window.MAIRA.GestionBatalla.togglePanel(false);
                        console.log('‚úÖ Panel ocultado');
                        return true;
                    }
                    return false;
                }
            }
        ];

        let exitosos = 0;
        for (const paso of pasos) {
            console.log(`\nüéØ ${paso.nombre}...`);
            try {
                const resultado = paso.accion();
                if (resultado) {
                    exitosos++;
                    console.log(`   ‚úÖ Completado`);
                } else {
                    console.log(`   ‚ùå Fall√≥`);
                }
                // Pausa entre pasos
                await new Promise(resolve => setTimeout(resolve, 1000));
            } catch (error) {
                console.error(`   üí• Error: ${error.message}`);
            }
        }

        console.log('\n' + '‚ïê'.repeat(60));
        console.log(`üìä DEMO COMPLETADA: ${exitosos}/${pasos.length} pasos exitosos`);
        console.log('üéÆ Prueba el bot√≥n flotante en el lado derecho para mostrar/ocultar el panel');
        console.log('üí¨ Env√≠a mensajes para ver las notificaciones en las pesta√±as');
        console.log('‚ïê'.repeat(60));
        
        return exitosos >= 4;
    }
}

// Hacer disponible globalmente
window.TestGestionBatalla = TestGestionBatalla;

// Auto-ejecutar si se llama directamente
if (typeof window !== 'undefined' && window.location) {
    window.ejecutarTestGestionBatalla = async function(rapido = false) {
        const test = new TestGestionBatalla();
        return rapido ? await test.testRapido() : await test.ejecutarTodosLosTests();
    };
    
    window.demoGestionBatalla = async function() {
        const test = new TestGestionBatalla();
        return await test.demoFuncionalidades();
    };
}

console.log('üß™ TestGestionBatalla cargado.');
console.log('üìã Comandos disponibles:');
console.log('  - ejecutarTestGestionBatalla() : Test completo');
console.log('  - ejecutarTestGestionBatalla(true) : Test r√°pido');
console.log('  - demoGestionBatalla() : Demo interactiva');
